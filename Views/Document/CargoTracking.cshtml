@model muhaberat_evrak_yonetim.Entities.Cargo

@{
    ViewData["Title"] = "Kargo Takip";
}

<style>
    .timeline {
        position: relative;
    }

    .timeline-item {
        position: relative;
        padding-left: 30px;
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .timeline-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .timeline-text {
        font-size: 12px;
        line-height: 1.4;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-truck mr-2"></i>Kargo Takip
        </h1>
        <a href="javascript:history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i>Geri Dön
        </a>
    </div>

    <div class="row">
        <!-- Kargo Bilgileri -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-box mr-2"></i>Kargo Bilgileri
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Takip Numarası:</strong> @Model.CargoTrackingNumber</p>
                            <p><strong>Kargo Şirketi:</strong> @(Model.CargoCompany ?? "Belirtilmemiş")</p>
                            <p><strong>Paket Türü:</strong> 
                                @switch (Model.PackageType)
                                {
                                    case "ENVELOPE":
                                        <span class="badge bg-light text-dark">Zarf</span>
                                        break;
                                    case "SMALL_PACKAGE":
                                        <span class="badge bg-secondary">Küçük Paket</span>
                                        break;
                                    case "LARGE_PACKAGE":
                                        <span class="badge bg-warning text-dark">Büyük Paket</span>
                                        break;
                                    case "SPECIAL":
                                        <span class="badge bg-danger">Özel</span>
                                        break;
                                    default:
                                        <span class="badge bg-light text-dark">@Model.PackageType</span>
                                        break;
                                }
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Durum:</strong> 
                                @switch (Model.DeliveryStatus)
                                {
                                    case "PREPARING":
                                        <span class="badge bg-warning text-dark">Hazırlanıyor</span>
                                        break;
                                    case "SHIPPED":
                                        <span class="badge bg-info">Kargoya Verildi</span>
                                        break;
                                    case "IN_TRANSIT":
                                        <span class="badge bg-primary">Yolda</span>
                                        break;
                                    case "DELIVERED":
                                        <span class="badge bg-success">Teslim Edildi</span>
                                        break;
                                    case "RETURNED":
                                        <span class="badge bg-danger">İade Edildi</span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary">@Model.DeliveryStatus</span>
                                        break;
                                }
                            </p>
                            <p><strong>Gönderim Tarihi:</strong> 
                                @if (Model.ShippingDate.HasValue)
                                {
                                    @Model.ShippingDate.Value.ToString("dd.MM.yyyy HH:mm")
                                }
                                else
                                {
                                    <span class="text-muted">Henüz gönderilmedi</span>
                                }
                            </p>
                            <p><strong>Tahmini Teslimat:</strong> 
                                @if (Model.EstimatedDeliveryDate.HasValue)
                                {
                                    @Model.EstimatedDeliveryDate.Value.ToString("dd.MM.yyyy")
                                }
                                else
                                {
                                    <span class="text-muted">Belirtilmemiş</span>
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kargodaki Evraklar -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-file-alt mr-2"></i>Bu Kargodaki Evraklar (@Model.Documents.Count adet)
                    </h6>
                </div>
                <div class="card-body">
                    @if (Model.Documents.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Evrak No</th>
                                        <th>Başlık</th>
                                        <th>Evrak Türü</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var doc in Model.Documents)
                                    {
                                        <tr>
                                            <td><strong>@doc.DocumentNumber</strong></td>
                                            <td>@doc.Title</td>
                                            <td>@(doc.DocumentType?.TypeName ?? "Belirtilmemiş")</td>
                                            <td>
                                                @switch (doc.Status)
                                                {
                                                    case "DRAFT":
                                                        <span class="badge bg-secondary">Taslak</span>
                                                        break;
                                                    case "SENT":
                                                        <span class="badge bg-primary">Gönderildi</span>
                                                        break;
                                                    case "DELIVERED":
                                                        <span class="badge bg-info">Teslim Edildi</span>
                                                        break;
                                                    case "RECEIVED":
                                                        <span class="badge bg-success">Alındı</span>
                                                        break;
                                                    case "CANCELLED":
                                                        <span class="badge bg-danger">İptal</span>
                                                        break;
                                                    default:
                                                        <span class="badge bg-light text-dark">@doc.Status</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                <a asp-action="Details" asp-route-id="@doc.Id" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> Görüntüle
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>Bu kargoda henüz evrak bulunmamaktadır.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Durum Güncelle -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-edit mr-2"></i>Durum Güncelle
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateCargoStatus" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="cargoId" value="@Model.Id" />
                        
                        <div class="form-group mb-3">
                            <label for="status" class="form-label">Yeni Durum</label>
                            <select name="status" class="form-control" required>
                                <option value="">Durum seçin</option>
                                @if (Model.DeliveryStatus == "PREPARING")
                                {
                                    <option value="PREPARING" selected>Hazırlanıyor</option>
                                }
                                else
                                {
                                    <option value="PREPARING">Hazırlanıyor</option>
                                }
                                
                                @if (Model.DeliveryStatus == "SHIPPED")
                                {
                                    <option value="SHIPPED" selected>Kargoya Verildi</option>
                                }
                                else
                                {
                                    <option value="SHIPPED">Kargoya Verildi</option>
                                }
                                
                                @if (Model.DeliveryStatus == "IN_TRANSIT")
                                {
                                    <option value="IN_TRANSIT" selected>Yolda</option>
                                }
                                else
                                {
                                    <option value="IN_TRANSIT">Yolda</option>
                                }
                                
                                @if (Model.DeliveryStatus == "DELIVERED")
                                {
                                    <option value="DELIVERED" selected>Teslim Edildi</option>
                                }
                                else
                                {
                                    <option value="DELIVERED">Teslim Edildi</option>
                                }
                                
                                @if (Model.DeliveryStatus == "RETURNED")
                                {
                                    <option value="RETURNED" selected>İade Edildi</option>
                                }
                                else
                                {
                                    <option value="RETURNED">İade Edildi</option>
                                }
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="location" class="form-label">Konum (opsiyonel)</label>
                            <input type="text" name="location" class="form-control" placeholder="Örn: İstanbul Merkez">
                        </div>

                        <div class="form-group mb-3">
                            <label for="notes" class="form-label">Notlar (opsiyonel)</label>
                            <textarea name="notes" class="form-control" rows="3" placeholder="Durum değişikliği hakkında not..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-warning btn-block">
                            <i class="fas fa-save mr-2"></i>Durumu Güncelle
                        </button>
                    </form>
                </div>
            </div>

            <!-- Geçmiş -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-history mr-2"></i>Kargo Geçmişi
                    </h6>
                </div>
                <div class="card-body">
                    @if (Model.CargoTrackingLogs.Any())
                    {
                        <div class="timeline">
                            @foreach (var log in Model.CargoTrackingLogs.OrderByDescending(l => l.StatusChangeDate))
                            {
                                <div class="timeline-item mb-3">
                                    <div class="timeline-marker bg-info"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title">
                                            @log.OldStatus → @log.NewStatus
                                        </h6>
                                        <p class="timeline-text text-muted small">
                                            @log.StatusChangeDate.ToString("dd.MM.yyyy HH:mm")
                                            @if (!string.IsNullOrEmpty(log.Location))
                                            {
                                                <br><strong>Konum:</strong> @log.Location
                                            }
                                            @if (!string.IsNullOrEmpty(log.Notes))
                                            {
                                                <br><strong>Not:</strong> @log.Notes
                                            }
                                            @if (log.UpdatedByUser != null)
                                            {
                                                <br><strong>Güncelleyen:</strong> @log.UpdatedByUser.FirstName @log.UpdatedByUser.LastName
                                            }
                                        </p>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>Henüz durum değişikliği geçmişi bulunmamaktadır.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

