@using muhaberat_evrak_yonetim.Entities
@{
    ViewData["Title"] = "Yönetim Paneli";
    var stats = ViewBag.AdminStats;
    var recentInactiveUsers = (stats.RecentInactiveUsers as List<User>) ?? new List<User>();
    var recentInactiveDepartments = (stats.RecentInactiveDepartments as List<Department>) ?? new List<Department>();
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-primary">
                <i class="fas fa-cogs mr-2"></i>Sistem Yönetim Paneli
            </h1>
            <p class="mb-0 text-muted">
                <i class="fas fa-shield-alt mr-1"></i>Aktif ve deaktif varlıkları yönetin
            </p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-home mr-2"></i>Ana Sayfa
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle mr-2"></i>@TempData["Success"]
            <button type="button" class="close" data-bs-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle mr-2"></i>@TempData["Error"]
            <button type="button" class="close" data-bs-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    }

    <!-- Overview Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Aktif Varlıklar
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(stats.TotalActiveUsers + stats.TotalActiveDepartments + stats.TotalActiveRoles + stats.TotalActiveDocumentTypes)
                            </div>
                            <div class="progress progress-sm mt-2">
                                <div class="progress-bar bg-success" style="width: 85%"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Deaktif Varlıklar
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(stats.TotalInactiveUsers + stats.TotalInactiveDepartments + stats.TotalInactiveRoles + stats.TotalInactiveDocumentTypes)
                            </div>
                            <div class="progress progress-sm mt-2">
                                <div class="progress-bar bg-danger" style="width: @(stats.TotalInactiveUsers > 0 ? 65 : 0)%"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Son 30 Gün Deaktif
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(stats.RecentlyDeactivatedUsers + stats.RecentlyDeactivatedDepartments)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-times fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Sistem Sağlığı
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @{
                                    var totalActive = stats.TotalActiveUsers + stats.TotalActiveDepartments + stats.TotalActiveRoles + stats.TotalActiveDocumentTypes;
                                    var totalInactive = stats.TotalInactiveUsers + stats.TotalInactiveDepartments + stats.TotalInactiveRoles + stats.TotalInactiveDocumentTypes;
                                    var healthPercentage = totalActive + totalInactive > 0 ? (totalActive * 100) / (totalActive + totalInactive) : 100;
                                }
                                %@Math.Round(healthPercentage, 1)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-heartbeat fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Management Cards -->
    <div class="row mb-4">
        <!-- Users Management -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users fa-lg mr-2"></i>
                        <h6 class="m-0 font-weight-bold">Kullanıcı Yönetimi</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col">
                            <div class="h4 mb-0 text-success">@stats.TotalActiveUsers</div>
                            <small class="text-muted">Aktif</small>
                        </div>
                        <div class="col">
                            <div class="h4 mb-0 text-danger">@stats.TotalInactiveUsers</div>
                            <small class="text-muted">Deaktif</small>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a asp-controller="User" asp-action="Index" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye mr-1"></i>Aktif Kullanıcılar
                        </a>
                        @if (stats.TotalInactiveUsers > 0)
                        {
                            <a asp-controller="User" asp-action="AllInactive" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-user-slash mr-1"></i>Deaktif Kullanıcılar (@stats.TotalInactiveUsers)
                            </a>
                        }
                        <a asp-controller="User" asp-action="Create" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-user-plus mr-1"></i>Yeni Kullanıcı
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Departments Management -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-building fa-lg mr-2"></i>
                        <h6 class="m-0 font-weight-bold">Departman Yönetimi</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col">
                            <div class="h4 mb-0 text-success">@stats.TotalActiveDepartments</div>
                            <small class="text-muted">Aktif</small>
                        </div>
                        <div class="col">
                            <div class="h4 mb-0 text-danger">@stats.TotalInactiveDepartments</div>
                            <small class="text-muted">Deaktif</small>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a asp-controller="Department" asp-action="Index" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye mr-1"></i>Aktif Departmanlar
                        </a>
                        @if (stats.TotalInactiveDepartments > 0)
                        {
                            <a asp-controller="Department" asp-action="AllInactive" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-building-slash mr-1"></i>Deaktif Departmanlar (@stats.TotalInactiveDepartments)
                            </a>
                        }
                        <a asp-controller="Department" asp-action="Create" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-plus mr-1"></i>Yeni Departman
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roles Management -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-tag fa-lg mr-2"></i>
                        <h6 class="m-0 font-weight-bold">Rol Yönetimi</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col">
                            <div class="h4 mb-0 text-success">@stats.TotalActiveRoles</div>
                            <small class="text-muted">Aktif</small>
                        </div>
                        <div class="col">
                            <div class="h4 mb-0 text-danger">@stats.TotalInactiveRoles</div>
                            <small class="text-muted">Deaktif</small>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a asp-controller="Role" asp-action="Index" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye mr-1"></i>Aktif Roller
                        </a>
                        @if (stats.TotalInactiveRoles > 0)
                        {
                            <a asp-controller="Role" asp-action="AllInactive" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-user-slash mr-1"></i>Deaktif Roller (@stats.TotalInactiveRoles)
                            </a>
                        }
                        <a asp-controller="Role" asp-action="Create" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-plus mr-1"></i>Yeni Rol
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Types Management -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-alt fa-lg mr-2"></i>
                        <h6 class="m-0 font-weight-bold">Evrak Türü Yönetimi</h6>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col">
                            <div class="h4 mb-0 text-success">@stats.TotalActiveDocumentTypes</div>
                            <small class="text-muted">Aktif</small>
                        </div>
                        <div class="col">
                            <div class="h4 mb-0 text-danger">@stats.TotalInactiveDocumentTypes</div>
                            <small class="text-muted">Deaktif</small>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a asp-controller="DocumentType" asp-action="Index" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye mr-1"></i>Aktif Türler
                        </a>
                        @if (stats.TotalInactiveDocumentTypes > 0)
                        {
                            <a asp-controller="DocumentType" asp-action="AllInactive" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-file-slash mr-1"></i>Deaktif Türler (@stats.TotalInactiveDocumentTypes)
                            </a>
                        }
                        <a asp-controller="DocumentType" asp-action="Create" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-plus mr-1"></i>Yeni Tür
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mb-4">
        <!-- Recent Inactive Users -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-user-slash mr-2"></i>Son Deaktif Edilen Kullanıcılar
                    </h6>
                </div>
                <div class="card-body">
                    @if (recentInactiveUsers.Any())
                    {
                        @foreach (var user in recentInactiveUsers.Take(5))
                        {
                            <div class="d-flex align-items-center justify-content-between mb-3 p-2 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar-inactive mr-3">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">@user.FirstName @user.LastName</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-building mr-1"></i>@(user.Department?.DepartmentName ?? "Departman Yok") ·
                                            <i class="fas fa-user-tag mr-1"></i>@(user.Role?.RoleName ?? "Rol Yok")
                                        </small>
                                        <br><small class="text-danger">
                                            <i class="fas fa-clock mr-1"></i>@user.UpdatedAt.ToString("dd.MM.yyyy HH:mm")
                                        </small>
                                    </div>
                                </div>
                                <div>
                                    <a asp-controller="User" asp-action="Details" asp-route-id="@user.Id" 
                                       class="btn btn-sm btn-outline-info" title="Detaylar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        }
                        <div class="text-center mt-3">
                            <a asp-controller="User" asp-action="AllInactive" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-list mr-1"></i>Tümünü Görüntüle (@stats.TotalInactiveUsers)
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                            <p class="text-muted mb-0">Deaktif kullanıcı bulunmamaktadır.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Recent Inactive Departments -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-building-slash mr-2"></i>Son Deaktif Edilen Departmanlar
                    </h6>
                </div>
                <div class="card-body">
                    @if (recentInactiveDepartments.Any())
                    {
                        @foreach (var dept in recentInactiveDepartments.Take(5))
                        {
                            <div class="d-flex align-items-center justify-content-between mb-3 p-2 bg-light rounded">
                                <div class="d-flex align-items-center">
                                    <div class="department-icon-inactive mr-3">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">@dept.DepartmentName</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-code mr-1"></i>@dept.DepartmentCode ·
                                            <i class="fas fa-sitemap mr-1"></i>@(dept.Unit?.UnitName ?? "Birim Yok")
                                        </small>
                                        @if (dept.HasFullAccess)
                                        {
                                            <br><span class="badge badge-warning badge-sm">
                                                <i class="fas fa-crown mr-1"></i>Tam Erişim
                                            </span>
                                        }
                                        <br><small class="text-danger">
                                            <i class="fas fa-clock mr-1"></i>@dept.CreatedAt.ToString("dd.MM.yyyy")
                                        </small>
                                    </div>
                                </div>
                                <div>
                                    <a asp-controller="Department" asp-action="Details" asp-route-id="@dept.Id" 
                                       class="btn btn-sm btn-outline-info" title="Detaylar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </div>
                        }
                        <div class="text-center mt-3">
                            <a asp-controller="Department" asp-action="AllInactive" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-list mr-1"></i>Tümünü Görüntüle (@stats.TotalInactiveDepartments)
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-building-check fa-2x text-success mb-2"></i>
                            <p class="text-muted mb-0">Deaktif departman bulunmamaktadır.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-bolt mr-2"></i>Hızlı Yönetim İşlemleri
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="p-3">
                                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                <h6>Kullanıcı İşlemleri</h6>
                                <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                    <a asp-controller="User" asp-action="Create" class="btn btn-outline-success">
                                        <i class="fas fa-user-plus mr-1"></i>Yeni Kullanıcı
                                    </a>
                                    @if (stats.TotalInactiveUsers > 0)
                                    {
                                        <a asp-controller="User" asp-action="AllInactive" class="btn btn-outline-danger">
                                            <i class="fas fa-user-times mr-1"></i>Deaktif Olanlar
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="p-3">
                                <i class="fas fa-building fa-2x text-info mb-2"></i>
                                <h6>Departman İşlemleri</h6>
                                <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                    <a asp-controller="Department" asp-action="Create" class="btn btn-outline-success">
                                        <i class="fas fa-plus mr-1"></i>Yeni Departman
                                    </a>
                                    @if (stats.TotalInactiveDepartments > 0)
                                    {
                                        <a asp-controller="Department" asp-action="AllInactive" class="btn btn-outline-danger">
                                            <i class="fas fa-building-times mr-1"></i>Deaktif Olanlar
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="p-3">
                                <i class="fas fa-user-tag fa-2x text-warning mb-2"></i>
                                <h6>Rol İşlemleri</h6>
                                <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                    <a asp-controller="Role" asp-action="Create" class="btn btn-outline-success">
                                        <i class="fas fa-plus mr-1"></i>Yeni Rol
                                    </a>
                                    @if (stats.TotalInactiveRoles > 0)
                                    {
                                        <a asp-controller="Role" asp-action="AllInactive" class="btn btn-outline-danger">
                                            <i class="fas fa-times mr-1"></i>Deaktif Olanlar
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="p-3">
                                <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                                <h6>Evrak Türü İşlemleri</h6>
                                <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                    <a asp-controller="DocumentType" asp-action="Create" class="btn btn-outline-success">
                                        <i class="fas fa-plus mr-1"></i>Yeni Tür
                                    </a>
                                    @if (stats.TotalInactiveDocumentTypes > 0)
                                    {
                                        <a asp-controller="DocumentType" asp-action="AllInactive" class="btn btn-outline-danger">
                                            <i class="fas fa-file-times mr-1"></i>Deaktif Olanlar
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .user-avatar-inactive {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: linear-gradient(135deg, #858796 0%, #60616f 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .department-icon-inactive {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        background: linear-gradient(135deg, #858796 0%, #60616f 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }

    .border-left-danger {
        border-left: 4px solid #e74a3b !important;
    }

    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }

    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }

    .d-grid {
        display: grid;
    }

    .gap-2 > * + * {
        margin-top: 0.5rem;
    }

    .badge-sm {
        font-size: 0.65em;
    }

    .fa-building-check::before {
        content: "\f19c";
    }

    .fa-building-slash::before {
        content: "\f1f8";
    }

    .fa-building-times::before {
        content: "\f1ad";
    }

    .fa-user-times::before {
        content: "\f235";
    }

    .fa-file-times::before {
        content: "\f317";
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Add tooltips
            $('[title]').tooltip();

            // Auto-refresh page every 5 minutes for real-time stats
            setTimeout(function() {
                location.reload();
            }, 300000); // 5 minutes

            // Quick stats refresh without page reload
            $('.refresh-stats').on('click', function(e) {
                e.preventDefault();
                location.reload();
            });
        });
    </script>
}